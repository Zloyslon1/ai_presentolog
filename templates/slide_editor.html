{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–æ—Ä —Å–ª–∞–π–¥–æ–≤{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-6 flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-900">–†–µ–¥–∞–∫—Ç–æ—Ä —Å–ª–∞–π–¥–æ–≤</h1>
        <div class="flex gap-3">
            <button onclick="window.location.href='/'" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                ‚Üê –ù–∞–∑–∞–¥
            </button>
            <button id="createBtn" onclick="generatePresentation(false)" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700">
                ‚ú® –°–æ–∑–¥–∞—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é
            </button>
        </div>
    </div>

    <!-- Progress bar -->
    <div id="progressBar" class="hidden mb-6">
        <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div id="progressBarFill" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <p id="progressText" class="text-sm text-gray-600 mt-2 text-center">–û–±—Ä–∞–±–æ—Ç–∫–∞...</p>
    </div>

    <div class="grid grid-cols-12 gap-6">
        <!-- Slides List (Left Panel) -->
        <div class="col-span-3">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">–°–ª–∞–π–¥—ã</h2>
                    <button onclick="addNewSlide()" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                        + –ù–æ–≤—ã–π
                    </button>
                </div>
                <div id="slidesList" class="space-y-2 max-h-[70vh] overflow-y-auto">
                    <!-- Slides will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Slide Editor (Center Panel) -->
        <div class="col-span-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="mb-4 flex justify-between items-center">
                    <h2 class="text-lg font-bold">–°–ª–∞–π–¥ <span id="currentSlideNumber">1</span></h2>
                    <button onclick="deleteCurrentSlide()" class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                        üóë –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>

                <!-- Slide Preview -->
                <div id="slidePreview" class="mb-6 border-2 border-gray-300 rounded-lg overflow-hidden bg-white relative" style="aspect-ratio: 16/9;">
                    <div id="previewImagesBackground" class="absolute inset-0" style="z-index: 1;"></div>
                    <div class="absolute inset-0 p-8 flex flex-col" style="z-index: 2;">
                        <div id="previewTitle" class="text-gray-900 text-3xl font-bold mb-4"></div>
                        <div id="previewMain" class="text-gray-900 text-lg flex-1 overflow-y-auto whitespace-pre-wrap"></div>
                        <div id="previewSecondary" class="text-gray-600 text-sm mt-2"></div>
                    </div>
                    <div id="previewImagesForeground" class="absolute inset-0" style="z-index: 3;"></div>
                </div>

                <!-- Text Editors -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ó–∞–≥–æ–ª–æ–≤–æ–∫ (‚â§6 —Å–ª–æ–≤)</label>
                        <input type="text" 
                               id="titleInput" 
                               class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="–ö—Ä–∞—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫"
                               oninput="updateSlidePreview()">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç
                            <span class="text-gray-500 font-normal">(–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–∏—Å–∫–∏ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å ":"):</span>
                        </label>
                        <textarea id="mainTextInput" 
                                  rows="8"
                                  class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                  placeholder="–û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏:&#10;–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø&#10;–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ&#10;&#10;‚Ä¢ –ü–µ—Ä–≤—ã–π –ø—É–Ω–∫—Ç&#10;‚Ä¢ –í—Ç–æ—Ä–æ–π –ø—É–Ω–∫—Ç"
                                  oninput="updateSlidePreview()"></textarea>
                        <p class="text-xs text-gray-500 mt-1">
                            –ü–æ–¥—Å–∫–∞–∑–∫–∞: –°—Ç—Ä–æ–∫–∏ —Å ":" —Å—Ç–∞–Ω—É—Ç –∂–∏—Ä–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏, —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏ - —Å–ø–∏—Å–∫–æ–º
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
                        </label>
                        <textarea id="secondaryTextInput" 
                                  rows="2"
                                  class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  placeholder="–°–Ω–æ—Å–∫–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏"
                                  oninput="updateSlidePreview()"></textarea>
                    </div>

                    <!-- Image Management -->
                    <div class="pt-4 border-t">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
                        <div class="space-y-2">
                            <button onclick="showImageModal()" class="w-full px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm">
                                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                            </button>
                            <div id="imagesList" class="space-y-1 max-h-32 overflow-y-auto">
                                <!-- Images will be listed here -->
                            </div>
                        </div>
                    </div>

                    <!-- Table Management -->
                    <div class="pt-4 border-t">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">–¢–∞–±–ª–∏—Ü—ã</h3>
                        <div class="space-y-2">
                            <button onclick="showTableModal()" class="w-full px-3 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm">
                                üìä –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É
                            </button>
                            <div id="tablesList" class="space-y-1 max-h-32 overflow-y-auto">
                                <!-- Tables will be listed here -->
                            </div>
                        </div>
                    </div>

                    <!-- Arrow Management -->
                    <div class="pt-4 border-t">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">–°—Ç—Ä–µ–ª–∫–∏</h3>
                        <div class="space-y-2">
                            <button onclick="showArrowModal()" class="w-full px-3 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 text-sm">
                                ‚û°Ô∏è –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–µ–ª–∫—É
                            </button>
                            <div id="arrowsList" class="space-y-1 max-h-32 overflow-y-auto">
                                <!-- Arrows will be listed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="col-span-3">
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="text-lg font-bold mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                
                <div class="space-y-4">
                    <!-- Page Orientation -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è</label>
                        <select id="pageOrientation" class="w-full p-2 border border-gray-300 rounded-lg" onchange="applyPageOrientation()">
                            <option value="horizontal">–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π (16:9)</option>
                            <option value="vertical">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π (9:16)</option>
                        </select>
                    </div>

                    <div class="pt-2 border-t">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">–†–∞–∑–º–µ—Ä—ã</h3>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–†–∞–∑–º–µ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–∞</label>
                        <input type="range" id="titleSize" min="24" max="60" value="44" class="w-full"
                               oninput="updatePreviewStyles(); document.getElementById('titleSizeValue').textContent = this.value">
                        <span id="titleSizeValue" class="text-sm text-gray-600">44</span> PT
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞</label>
                        <input type="range" id="textSize" min="12" max="32" value="18" class="w-full"
                               oninput="updatePreviewStyles(); document.getElementById('textSizeValue').textContent = this.value">
                        <span id="textSizeValue" class="text-sm text-gray-600">18</span> PT
                    </div>

                    <!-- Font Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–®—Ä–∏—Ñ—Ç</label>
                        <select id="fontFamily" class="w-full p-2 border border-gray-300 rounded-lg" onchange="changeFontFamily()">
                            <optgroup label="–°–∏—Å—Ç–µ–º–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã">
                                <option value="Arial" selected>Arial</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Calibri">Calibri</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Tahoma">Tahoma</option>
                                <option value="Trebuchet MS">Trebuchet MS</option>
                                <option value="Helvetica">Helvetica</option>
                            </optgroup>
                            <optgroup label="Google Fonts">
                                <option data-google="true" value="Roboto">Roboto</option>
                                <option data-google="true" value="Open Sans">Open Sans</option>
                                <option data-google="true" value="Lato">Lato</option>
                                <option data-google="true" value="Montserrat">Montserrat</option>
                                <option data-google="true" value="Oswald">Oswald</option>
                                <option data-google="true" value="Raleway">Raleway</option>
                                <option data-google="true" value="Poppins">Poppins</option>
                                <option data-google="true" value="Inter">Inter</option>
                                <option data-google="true" value="Noto Sans">Noto Sans</option>
                                <option data-google="true" value="Noto Serif">Noto Serif</option>
                                <option data-google="true" value="Merriweather">Merriweather</option>
                                <option data-google="true" value="Source Sans 3">Source Sans 3</option>
                                <option data-google="true" value="Playfair Display">Playfair Display</option>
                                <option data-google="true" value="PT Sans">PT Sans</option>
                                <option data-google="true" value="PT Serif">PT Serif</option>
                                <option data-google="true" value="Ubuntu">Ubuntu</option>
                                <option data-google="true" value="Work Sans">Work Sans</option>
                                <option data-google="true" value="Nunito">Nunito</option>
                                <option data-google="true" value="Quicksand">Quicksand</option>
                                <option data-google="true" value="Rubik">Rubik</option>
                                <option data-google="true" value="Heebo">Heebo</option>
                                <option data-google="true" value="Mulish">Mulish</option>
                                <option data-google="true" value="Karla">Karla</option>
                                <option data-google="true" value="IBM Plex Sans">IBM Plex Sans</option>
                                <option data-google="true" value="DM Sans">DM Sans</option>
                                <option data-google="true" value="Inconsolata">Inconsolata</option>
                                <option data-google="true" value="Fira Sans">Fira Sans</option>
                                <option data-google="true" value="Cabin">Cabin</option>
                                <option data-google="true" value="Anton">Anton</option>
                                <option data-google="true" value="Abril Fatface">Abril Fatface</option>
                                <option data-google="true" value="Arvo">Arvo</option>
                                <option data-google="true" value="Barlow">Barlow</option>
                                <option data-google="true" value="Cormorant Garamond">Cormorant Garamond</option>
                                <option data-google="true" value="Exo 2">Exo 2</option>
                                <option data-google="true" value="Josefin Sans">Josefin Sans</option>
                                <option data-google="true" value="Libre Baskerville">Libre Baskerville</option>
                                <option data-google="true" value="Manrope">Manrope</option>
                                <option data-google="true" value="Merriweather Sans">Merriweather Sans</option>
                                <option data-google="true" value="Righteous">Righteous</option>
                                <option data-google="true" value="Roboto Condensed">Roboto Condensed</option>
                                <option data-google="true" value="Roboto Slab">Roboto Slab</option>
                                <option data-google="true" value="Source Serif 4">Source Serif 4</option>
                                <option data-google="true" value="Tangerine">Tangerine</option>
                                <option data-google="true" value="Teko">Teko</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- Text Positioning -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</label>
                        <div class="space-y-2">
                            <div>
                                <span class="text-xs text-gray-600">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ:</span>
                                <div class="flex gap-1 mt-1">
                                    <button onclick="changeTextPosition('top', null)" id="posVertTop" class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded bg-blue-100 border-blue-500">–°–≤–µ—Ä—Ö—É</button>
                                    <button onclick="changeTextPosition('center', null)" id="posVertCenter" class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">–ü–æ —Ü–µ–Ω—Ç—Ä—É</button>
                                    <button onclick="changeTextPosition('bottom', null)" id="posVertBottom" class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">–°–Ω–∏–∑—É</button>
                                </div>
                            </div>
                            <div>
                                <span class="text-xs text-gray-600">–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ:</span>
                                <div class="flex gap-1 mt-1">
                                    <button onclick="changeTextPosition(null, 'left')" id="posHorizLeft" class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded bg-blue-100 border-blue-500">–°–ª–µ–≤–∞</button>
                                    <button onclick="changeTextPosition(null, 'center')" id="posHorizCenter" class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">–ü–æ —Ü–µ–Ω—Ç—Ä—É</button>
                                    <button onclick="changeTextPosition(null, 'right')" id="posHorizRight" class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50">–°–ø—Ä–∞–≤–∞</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4 border-t">
                        <button onclick="applyToAll()" class="w-full px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">
                            –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º —Å–ª–∞–π–¥–∞–º
                        </button>
                    </div>
                </div>
            </div>

            <!-- Info Panel -->
            <div class="bg-blue-50 rounded-lg p-4 mt-4">
                <h3 class="font-bold text-blue-900 mb-2">üí° –°–æ–≤–µ—Ç—ã</h3>
                <ul class="text-xs text-blue-800 space-y-1">
                    <li>‚Ä¢ –ó–∞–≥–æ–ª–æ–≤–∫–∏: –¥–æ 6 —Å–ª–æ–≤</li>
                    <li>‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ":" –¥–ª—è –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤</li>
                    <li>‚Ä¢ "‚Ä¢" –∏–ª–∏ "-" –¥–ª—è —Å–ø–∏—Å–∫–æ–≤</li>
                    <li>‚Ä¢ –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ = –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <h3 class="text-lg font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3>
        
        <!-- Upload Method Tabs -->
        <div class="flex gap-2 mb-4 border-b">
            <button id="tabUrl" onclick="switchImageTab('url')" class="px-4 py-2 border-b-2 border-blue-500 text-blue-500 font-medium">URL</button>
            <button id="tabDragDrop" onclick="switchImageTab('dragdrop')" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">Drag & Drop</button>
            <button id="tabUpload" onclick="switchImageTab('upload')" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">Upload File</button>
        </div>
        
        <!-- Tab Content -->
        <div class="space-y-4">
            <!-- URL Tab -->
            <div id="tabContentUrl" class="tab-content">
                <label class="block text-sm font-medium text-gray-700 mb-2">URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                <input type="url" id="imageUrl" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="https://example.com/image.jpg">
                <p class="text-xs text-gray-500 mt-1">Paste a direct link to an image (JPG, PNG, GIF, WebP, SVG)</p>
            </div>
            
            <!-- Drag & Drop Tab -->
            <div id="tabContentDragDrop" class="tab-content hidden">
                <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition">
                    <p class="text-gray-500 mb-2">üìÅ Drag image file here or click to browse</p>
                    <p class="text-xs text-gray-400">Supported: JPG, PNG, GIF, WebP, SVG (max 5MB)</p>
                    <input type="file" id="dropZoneFileInput" accept="image/jpeg,image/png,image/gif,image/webp,image/svg+xml" class="hidden">
                </div>
                <p id="dropZoneFileName" class="text-sm text-gray-600 mt-2 hidden"></p>
            </div>
            
            <!-- Upload File Tab -->
            <div id="tabContentUpload" class="tab-content hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Choose File</label>
                <input type="file" id="fileUploadInput" accept="image/jpeg,image/png,image/gif,image/webp,image/svg+xml" class="w-full p-2 border border-gray-300 rounded-lg">
                <p class="text-xs text-gray-500 mt-1">Supported formats: JPG, PNG, GIF, WebP, SVG (max 5MB)</p>
                <div id="fileUploadPreview" class="mt-2 hidden">
                    <img id="fileUploadThumb" class="max-w-full h-32 object-contain border rounded" />
                </div>
            </div>
            
            <!-- Common Controls -->
            <div class="pt-4 border-t space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs text-gray-600">X (pixels)</label>
                            <input type="number" id="imageX" value="100" class="w-full p-2 border border-gray-300 rounded">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600">Y (pixels)</label>
                            <input type="number" id="imageY" value="100" class="w-full p-2 border border-gray-300 rounded">
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Size</label>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs text-gray-600">Width (pixels)</label>
                            <input type="number" id="imageWidth" value="200" class="w-full p-2 border border-gray-300 rounded" oninput="handleImageSizeChange('width')">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600">Height (pixels)</label>
                            <input type="number" id="imageHeight" value="150" class="w-full p-2 border border-gray-300 rounded" oninput="handleImageSizeChange('height')">
                        </div>
                    </div>
                    <label class="flex items-center mt-2 text-sm">
                        <input type="checkbox" id="imageAspectLock" checked class="mr-2">
                        <span class="text-gray-700">üîó Lock aspect ratio</span>
                    </label>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Layer</label>
                    <div class="flex gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="imageLayer" value="background" checked class="mr-2">
                            <span class="text-sm">Behind Text</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="imageLayer" value="foreground" class="mr-2">
                            <span class="text-sm">In Front of Text</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex gap-2 mt-6">
            <button onclick="addImage()" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button onclick="closeImageModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<!-- Table Modal -->
<div id="tableModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
        <h3 class="text-lg font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</h3>
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ç—Ä–æ–∫–∏</label>
                    <input type="number" id="tableRows" min="1" max="10" value="3" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ç–æ–ª–±—Ü—ã</label>
                    <input type="number" id="tableColumns" min="1" max="8" value="3" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-sm text-gray-700">X (–ø–∏–∫—Å–µ–ª–∏)</label>
                    <input type="number" id="tableX" value="50" class="w-full p-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-sm text-gray-700">Y (–ø–∏–∫—Å–µ–ª–∏)</label>
                    <input type="number" id="tableY" value="200" class="w-full p-2 border border-gray-300 rounded">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-sm text-gray-700">–®–∏—Ä–∏–Ω–∞</label>
                    <input type="number" id="tableWidth" value="500" class="w-full p-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-sm text-gray-700">–í—ã—Å–æ—Ç–∞</label>
                    <input type="number" id="tableHeight" value="200" class="w-full p-2 border border-gray-300 rounded">
                </div>
            </div>
        </div>
        <div class="flex gap-2 mt-6">
            <button onclick="addTable()" class="flex-1 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button onclick="closeTableModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<!-- Arrow Modal -->
<div id="arrowModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
        <h3 class="text-lg font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–µ–ª–∫—É</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">–¢–∏–ø —Å—Ç—Ä–µ–ª–∫–∏</label>
                <select id="arrowType" class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="straight">–ü—Ä—è–º–∞—è</option>
                    <option value="bent">–° –∏–∑–ª–æ–º–æ–º</option>
                    <option value="curved">–ò–∑–æ–≥–Ω—É—Ç–∞—è</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-sm text-gray-700">–ù–∞—á–∞–ª–æ X</label>
                    <input type="number" id="arrowStartX" value="100" class="w-full p-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-sm text-gray-700">–ù–∞—á–∞–ª–æ Y</label>
                    <input type="number" id="arrowStartY" value="150" class="w-full p-2 border border-gray-300 rounded">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-sm text-gray-700">–ö–æ–Ω–µ—Ü X</label>
                    <input type="number" id="arrowEndX" value="300" class="w-full p-2 border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-sm text-gray-700">–ö–æ–Ω–µ—Ü Y</label>
                    <input type="number" id="arrowEndY" value="150" class="w-full p-2 border border-gray-300 rounded">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-sm text-gray-700">–¶–≤–µ—Ç</label>
                    <input type="color" id="arrowColor" value="#000000" class="w-full p-1 border border-gray-300 rounded h-10">
                </div>
                <div>
                    <label class="block text-sm text-gray-700">–¢–æ–ª—â–∏–Ω–∞ (PT)</label>
                    <input type="number" id="arrowStroke" min="1" max="10" value="2" class="w-full p-2 border border-gray-300 rounded">
                </div>
            </div>
        </div>
        <div class="flex gap-2 mt-6">
            <button onclick="addArrow()" class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button onclick="closeArrowModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<script>
let slides = {{ slides_data | tojson }};
let currentSlideIndex = 0;
const presentationUrl = '{{ presentation_url }}';
let generatedPresentationId = null;  // Track generated presentation

// Settings state
let presentationSettings = {
    pageOrientation: 'horizontal',
    defaultFont: 'Arial',
    defaultFontSize: 18,
    defaultTextPosition: {
        vertical: 'top',
        horizontal: 'left'
    }
};

// Get job ID for settings persistence
const urlParams = new URLSearchParams(window.location.search);
const jobId = urlParams.get('job_id') || 'default';

// Initialize
let isFirstLoad = true;
document.addEventListener('DOMContentLoaded', () => {
    console.log('DEBUG: Loaded slides data:', slides);
    console.log('DEBUG: First slide:', slides[0]);
    loadSettings();
    initializeSlideData();
    renderSlidesList();
    loadSlide(0);
    isFirstLoad = false;  // –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
    
    // Check if we have a generated presentation from previous run
    if (jobId && jobId !== 'default') {
        checkForGeneratedPresentation(jobId);
    }
    
    // Setup drag-and-drop for slide preview
    setupPreviewDragDrop();
    
    // Setup file input handlers
    setupFileInputHandlers();
});

function checkForGeneratedPresentation(jobId) {
    // Check if this job already generated a presentation
    fetch(`/api/job/${jobId}`)
        .then(response => response.json())
        .then(job => {
            if (job.generated_presentation_id) {
                generatedPresentationId = job.generated_presentation_id;
                // Show update button, hide create button
                document.getElementById('createBtn').classList.add('hidden');
                document.getElementById('updateBtn').classList.remove('hidden');
            }
        })
        .catch(err => console.error('Error checking job:', err));
}

function renderSlidesList() {
    const container = document.getElementById('slidesList');
    if (slides.length === 0) {
        container.innerHTML = '<div class="p-4 text-gray-500 text-sm">–ù–µ—Ç —Å–ª–∞–π–¥–æ–≤</div>';
        return;
    }
    console.log('DEBUG renderSlidesList: slides count =', slides.length);
    container.innerHTML = slides.map((slide, index) => {
        const title = slide.title || '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞';
        const preview = (slide.mainText || '').substring(0, 30);
        console.log(`DEBUG slide ${index}: title='${title}', mainText length=${(slide.mainText || '').length}, preview='${preview}'`);
        return `
        <div onclick="loadSlide(${index})" 
             class="p-3 rounded cursor-pointer transition ${index === currentSlideIndex ? 'bg-blue-100 border-2 border-blue-500' : 'bg-gray-50 hover:bg-gray-100 border border-gray-200'}">
            <div class="font-semibold text-sm">${index + 1}. ${title}</div>
            <div class="text-xs text-gray-500 mt-1 truncate">${preview}${preview ? '...' : ''}</div>
        </div>
    `;
    }).join('');
}

function loadSlide(index) {
    // Save current slide first (BUT NOT on first load when inputs are empty!)
    if (currentSlideIndex >= 0 && currentSlideIndex < slides.length && !isFirstLoad) {
        saveCurrentSlide();
    }

    currentSlideIndex = index;
    const slide = slides[index];
    
    console.log(`DEBUG loadSlide(${index}):`, slide);
    console.log(`  title: '${slide.title}'`);
    console.log(`  mainText: '${slide.mainText}'`);
    console.log(`  mainText length: ${(slide.mainText || '').length}`);

    document.getElementById('currentSlideNumber').textContent = index + 1;
    document.getElementById('titleInput').value = slide.title || '';
    document.getElementById('mainTextInput').value = slide.mainText || '';
    document.getElementById('secondaryTextInput').value = slide.secondaryText || '';
    
    console.log(`  After setting inputs:`);
    console.log(`    titleInput.value: '${document.getElementById('titleInput').value}'`);
    console.log(`    mainTextInput.value: '${document.getElementById('mainTextInput').value}'`);
    
    // Load slide-specific settings
    if (slide.fontFamily) {
        document.getElementById('fontFamily').value = slide.fontFamily;
    }
    if (slide.titleSize) {
        document.getElementById('titleSize').value = slide.titleSize;
        document.getElementById('titleSizeValue').textContent = slide.titleSize;
    }
    if (slide.textSize) {
        document.getElementById('textSize').value = slide.textSize;
        document.getElementById('textSizeValue').textContent = slide.textSize;
    }

    // Ensure Google Fonts are loaded when switching slides
    changeFontFamily();

    updateSlidePreview();
    updateImagesList();
    updateTablesList();
    updateArrowsList();
    renderSlidesList();
}

function saveCurrentSlide() {
    slides[currentSlideIndex] = {
        ...slides[currentSlideIndex],
        title: document.getElementById('titleInput').value,
        mainText: document.getElementById('mainTextInput').value,
        secondaryText: document.getElementById('secondaryTextInput').value,
        fontFamily: document.getElementById('fontFamily').value,
        titleSize: parseInt(document.getElementById('titleSize').value),
        textSize: parseInt(document.getElementById('textSize').value),
        textPosition: {
            vertical: presentationSettings.defaultTextPosition.vertical,
            horizontal: presentationSettings.defaultTextPosition.horizontal
        },
        images: slides[currentSlideIndex].images || [],
        tables: slides[currentSlideIndex].tables || [],
        arrows: slides[currentSlideIndex].arrows || []
    };
}

function updateSlidePreview() {
    const title = document.getElementById('titleInput').value;
    const mainText = document.getElementById('mainTextInput').value;
    const secondaryText = document.getElementById('secondaryTextInput').value;

    // Update text preview
    document.getElementById('previewTitle').textContent = title;
    document.getElementById('previewMain').innerHTML = formatMainText(mainText);
    document.getElementById('previewSecondary').textContent = secondaryText;

    updatePreviewStyles();
    
    // Render images in layers
    renderPreviewImages();
}

function renderPreviewImages() {
    const images = slides[currentSlideIndex].images || [];
    const bgContainer = document.getElementById('previewImagesBackground');
    const fgContainer = document.getElementById('previewImagesForeground');
    
    // Clear existing images
    bgContainer.innerHTML = '';
    fgContainer.innerHTML = '';
    
    // Separate images by layer
    const backgroundImages = images.filter(img => img.layer !== 'foreground');
    const foregroundImages = images.filter(img => img.layer === 'foreground');
    
    // Render background images
    backgroundImages.forEach(img => {
        const imgEl = document.createElement('img');
        imgEl.src = img.url;
        imgEl.style.position = 'absolute';
        imgEl.style.left = `${img.position.x}px`;
        imgEl.style.top = `${img.position.y}px`;
        imgEl.style.width = `${img.size.width}px`;
        imgEl.style.height = `${img.size.height}px`;
        imgEl.style.objectFit = 'cover';
        imgEl.style.pointerEvents = 'none';
        imgEl.onerror = function() {
            this.style.border = '2px dashed #ccc';
            this.style.background = '#f0f0f0';
            this.alt = 'Image failed to load';
        };
        bgContainer.appendChild(imgEl);
    });
    
    // Render foreground images
    foregroundImages.forEach(img => {
        const imgEl = document.createElement('img');
        imgEl.src = img.url;
        imgEl.style.position = 'absolute';
        imgEl.style.left = `${img.position.x}px`;
        imgEl.style.top = `${img.position.y}px`;
        imgEl.style.width = `${img.size.width}px`;
        imgEl.style.height = `${img.size.height}px`;
        imgEl.style.objectFit = 'cover';
        imgEl.style.pointerEvents = 'none';
        imgEl.onerror = function() {
            this.style.border = '2px dashed #ccc';
            this.style.background = '#f0f0f0';
            this.alt = 'Image failed to load';
        };
        fgContainer.appendChild(imgEl);
    });
}

function formatMainText(text) {
    if (!text) return '';
    
    const lines = text.split('\n');
    let html = '';
    
    for (let line of lines) {
        if (line.trim().endsWith(':')) {
            // Bold heading
            html += `<div class="font-bold mt-2">${line}</div>`;
        } else if (line.trim().startsWith('‚Ä¢') || line.trim().startsWith('-')) {
            // Bullet point
            html += `<div class="ml-4">${line}</div>`;
        } else if (line.trim().match(/^\d+\./)) {
            // Numbered list
            html += `<div class="ml-4">${line}</div>`;
        } else if (line.trim()) {
            html += `<div>${line}</div>`;
        } else {
            html += '<div class="h-2"></div>';
        }
    }
    
    return html;
}

function updatePreviewStyles() {
    const titleSize = document.getElementById('titleSize').value;
    const textSize = document.getElementById('textSize').value;
    const fontFamily = document.getElementById('fontFamily').value;
    
    document.getElementById('previewTitle').style.fontSize = `${titleSize}px`;
    document.getElementById('previewMain').style.fontSize = `${textSize}px`;
    document.getElementById('previewTitle').style.fontFamily = fontFamily;
    document.getElementById('previewMain').style.fontFamily = fontFamily;
    document.getElementById('previewSecondary').style.fontFamily = fontFamily;
    
    // Apply text positioning
    const previewContainer = document.getElementById('slidePreview').querySelector('.absolute');
    const vertical = presentationSettings.defaultTextPosition.vertical;
    const horizontal = presentationSettings.defaultTextPosition.horizontal;
    
    // Vertical alignment
    previewContainer.style.justifyContent = 
        vertical === 'top' ? 'flex-start' : 
        vertical === 'center' ? 'center' : 'flex-end';
    
    // Horizontal alignment
    previewContainer.style.alignItems = 
        horizontal === 'left' ? 'flex-start' : 
        horizontal === 'center' ? 'center' : 'flex-end';
}

function addNewSlide() {
    const newSlide = {
        title: '',
        mainText: '',
        secondaryText: '',
        role: 'CONTENT'
    };
    
    slides.push(newSlide);
    renderSlidesList();
    loadSlide(slides.length - 1);
}

function deleteCurrentSlide() {
    if (slides.length <= 1) {
        alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–ª–∞–π–¥!');
        return;
    }
    
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Å–ª–∞–π–¥ ${currentSlideIndex + 1}?`)) {
        return;
    }
    
    slides.splice(currentSlideIndex, 1);
    currentSlideIndex = Math.max(0, currentSlideIndex - 1);
    renderSlidesList();
    loadSlide(currentSlideIndex);
}

function applyToAll() {
    const titleSize = document.getElementById('titleSize').value;
    const textSize = document.getElementById('textSize').value;
    const fontFamily = document.getElementById('fontFamily').value;
    const textPosition = presentationSettings.defaultTextPosition;
    
    slides = slides.map(slide => ({
        ...slide,
        titleSize: parseInt(titleSize),
        textSize: parseInt(textSize),
        fontFamily: fontFamily,
        textPosition: {...textPosition}
    }));
    
    alert('–°—Ç–∏–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫–æ –≤—Å–µ–º —Å–ª–∞–π–¥–∞–º!');
}

function applyTemplateToAll() {
    const template = document.getElementById('templateSelect').value;
    slides = slides.map(slide => ({
        ...slide,
        template: template
    }));
}

async function generatePresentation(isUpdate = false) {
    // Save current slide
    saveCurrentSlide();
    
    // Show progress
    document.getElementById('progressBar').classList.remove('hidden');
    document.getElementById('progressBarFill').style.width = '20%';
    
    if (isUpdate && generatedPresentationId) {
        document.getElementById('progressText').textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏...';
    } else {
        document.getElementById('progressText').textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–ª–∞–π–¥–æ–≤...';
    }
    
    try {
        const response = await fetch('/process_slides', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                slides: slides,
                presentation_url: presentationUrl,
                existing_presentation_id: isUpdate ? generatedPresentationId : null,
                settings: presentationSettings
            })
        });
        
        document.getElementById('progressBarFill').style.width = '50%';
        document.getElementById('progressText').textContent = isUpdate ? '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏...' : '–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏...';
        
        const result = await response.json();
        
        document.getElementById('progressBarFill').style.width = '100%';
        document.getElementById('progressText').textContent = '–ì–æ—Ç–æ–≤–æ!';
        
        if (result.job_id) {
            window.location.href = `/job/${result.job_id}`;
        } else if (result.error) {
            alert('–û—à–∏–±–∫–∞: ' + result.error);
            document.getElementById('progressBar').classList.add('hidden');
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ ' + (isUpdate ? '–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏' : '—Å–æ–∑–¥–∞–Ω–∏–∏') + ' –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏: ' + error);
        document.getElementById('progressBar').classList.add('hidden');
    }
}

// Initialize slide data with default values
function initializeSlideData() {
    slides = slides.map(slide => ({
        ...slide,
        fontFamily: slide.fontFamily || presentationSettings.defaultFont,
        titleSize: slide.titleSize || 44,
        textSize: slide.textSize || 18,
        textPosition: slide.textPosition || {...presentationSettings.defaultTextPosition},
        images: slide.images || [],
        tables: slide.tables || [],
        arrows: slide.arrows || []
    }));
}

// Settings persistence functions
function saveSettings() {
    presentationSettings.defaultFont = document.getElementById('fontFamily').value;
    presentationSettings.defaultFontSize = parseInt(document.getElementById('textSize').value);
    
    try {
        localStorage.setItem(
            'presentation_settings_' + jobId,
            JSON.stringify(presentationSettings)
        );
    } catch (e) {
        console.warn('Failed to save settings to localStorage:', e);
    }
}

function loadSettings() {
    try {
        const stored = localStorage.getItem('presentation_settings_' + jobId);
        if (stored) {
            const settings = JSON.parse(stored);
            presentationSettings = {...presentationSettings, ...settings};
            
            // Apply to UI
            document.getElementById('pageOrientation').value = presentationSettings.pageOrientation;
            applyPageOrientation();
        }
    } catch (e) {
        console.warn('Failed to load settings from localStorage:', e);
    }
}

// Page orientation control
function applyPageOrientation() {
    const orientation = document.getElementById('pageOrientation').value;
    presentationSettings.pageOrientation = orientation;
    
    const preview = document.getElementById('slidePreview');
    if (orientation === 'vertical') {
        // Portrait: keep height constrained and derive width from aspect ratio
        preview.style.aspectRatio = '9/16';
        preview.style.height = '70vh';
        preview.style.maxHeight = '70vh';
        preview.style.width = 'auto';
        preview.style.maxWidth = '100%';
        preview.style.display = 'inline-block';
        preview.style.marginLeft = 'auto';
        preview.style.marginRight = 'auto';
    } else {
        // Landscape: fill width but cap height
        preview.style.aspectRatio = '16/9';
        preview.style.height = 'auto';
        preview.style.maxHeight = '70vh';
        preview.style.width = '100%';
        preview.style.display = 'block';
        preview.style.marginLeft = '';
        preview.style.marginRight = '';
    }
    
    saveSettings();
}

// Font selection control
function changeFontFamily() {
    const select = document.getElementById('fontFamily');
    const fontFamily = select.value;
    presentationSettings.defaultFont = fontFamily;

    const selectedOption = select.selectedOptions && select.selectedOptions[0];
    const isGoogleFont = selectedOption && selectedOption.dataset && selectedOption.dataset.google === 'true';

    if (isGoogleFont) {
        // Load Google Font via WebFont Loader if available, else fallback to CSS link
        if (window.WebFont && window.WebFont.load) {
            WebFont.load({ google: { families: [fontFamily] } });
        } else {
            const familyParam = fontFamily.replace(/ /g, '+');
            const href = `https://fonts.googleapis.com/css2?family=${familyParam}:wght@400;700&display=swap`;
            if (!document.querySelector(`link[data-font="${familyParam}"]`)) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = href;
                link.setAttribute('data-font', familyParam);
                document.head.appendChild(link);
            }
        }
    }
    updatePreviewStyles();
    saveSettings();
}

// Text positioning control
function changeTextPosition(vertical, horizontal) {
    if (vertical !== null) {
        presentationSettings.defaultTextPosition.vertical = vertical;
        
        // Update button styles
        ['posVertTop', 'posVertCenter', 'posVertBottom'].forEach(id => {
            const btn = document.getElementById(id);
            btn.classList.remove('bg-blue-100', 'border-blue-500');
            btn.classList.add('hover:bg-gray-50');
        });
        document.getElementById('posVert' + vertical.charAt(0).toUpperCase() + vertical.slice(1)).classList.add('bg-blue-100', 'border-blue-500');
    }
    
    if (horizontal !== null) {
        presentationSettings.defaultTextPosition.horizontal = horizontal;
        
        // Update button styles
        ['posHorizLeft', 'posHorizCenter', 'posHorizRight'].forEach(id => {
            const btn = document.getElementById(id);
            btn.classList.remove('bg-blue-100', 'border-blue-500');
            btn.classList.add('hover:bg-gray-50');
        });
        const horizBtnId = horizontal === 'left' ? 'posHorizLeft' : 
                           horizontal === 'center' ? 'posHorizCenter' : 'posHorizRight';
        document.getElementById(horizBtnId).classList.add('bg-blue-100', 'border-blue-500');
    }
    
    updatePreviewStyles();
    saveSettings();
}

// Image management functions
let currentImageMode = 'url'; // Track active tab
let currentEditingImageId = null; // Track image being edited
let currentImageAspectRatio = null; // Store aspect ratio

function showImageModal() {
    currentEditingImageId = null;
    resetImageModal();
    document.getElementById('imageModal').classList.remove('hidden');
}

function closeImageModal() {
    document.getElementById('imageModal').classList.add('hidden');
    resetImageModal();
}

function resetImageModal() {
    // Reset all inputs
    document.getElementById('imageUrl').value = '';
    document.getElementById('imageX').value = '100';
    document.getElementById('imageY').value = '100';
    document.getElementById('imageWidth').value = '200';
    document.getElementById('imageHeight').value = '150';
    document.getElementById('imageAspectLock').checked = true;
    document.querySelector('input[name="imageLayer"][value="background"]').checked = true;
    
    // Reset file inputs
    const dropZoneInput = document.getElementById('dropZoneFileInput');
    const fileUploadInput = document.getElementById('fileUploadInput');
    if (dropZoneInput) dropZoneInput.value = '';
    if (fileUploadInput) fileUploadInput.value = '';
    
    // Hide previews
    document.getElementById('dropZoneFileName').classList.add('hidden');
    document.getElementById('fileUploadPreview').classList.add('hidden');
    
    // Reset aspect ratio
    currentImageAspectRatio = null;
    
    // Switch to URL tab
    switchImageTab('url');
}

function switchImageTab(mode) {
    currentImageMode = mode;
    
    // Update tab buttons and content visibility
    const tabs = {
        'url': { btn: 'tabUrl', content: 'tabContentUrl' },
        'dragdrop': { btn: 'tabDragDrop', content: 'tabContentDragDrop' },
        'upload': { btn: 'tabUpload', content: 'tabContentUpload' }
    };
    
    Object.keys(tabs).forEach(tab => {
        const btn = document.getElementById(tabs[tab].btn);
        const content = document.getElementById(tabs[tab].content);
        
        if (!btn || !content) return;
        
        if (tab === mode) {
            btn.classList.add('border-blue-500', 'text-blue-500', 'font-medium');
            btn.classList.remove('border-transparent', 'text-gray-500');
            content.classList.remove('hidden');
        } else {
            btn.classList.remove('border-blue-500', 'text-blue-500', 'font-medium');
            btn.classList.add('border-transparent', 'text-gray-500');
            content.classList.add('hidden');
        }
    });
}

function handleImageSizeChange(changedDimension) {
    const aspectLocked = document.getElementById('imageAspectLock').checked;
    
    if (!aspectLocked || !currentImageAspectRatio) {
        return;
    }
    
    const widthInput = document.getElementById('imageWidth');
    const heightInput = document.getElementById('imageHeight');
    
    if (changedDimension === 'width') {
        const newWidth = parseInt(widthInput.value);
        const newHeight = Math.round(newWidth / currentImageAspectRatio);
        heightInput.value = newHeight;
    } else {
        const newHeight = parseInt(heightInput.value);
        const newWidth = Math.round(newHeight * currentImageAspectRatio);
        widthInput.value = newWidth;
    }
}

function validateImageFile(file) {
    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/svg+xml'];
    const maxSize = 5 * 1024 * 1024; // 5MB
    
    if (!validTypes.includes(file.type)) {
        alert('File type not supported. Use JPG, PNG, GIF, WebP, or SVG');
        return false;
    }
    
    if (file.size > maxSize) {
        alert('File exceeds 5MB limit. Please use a smaller image');
        return false;
    }
    
    return true;
}

function processImageFile(file) {
    if (!validateImageFile(file)) {
        return;
    }
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        const dataUrl = e.target.result;
        document.getElementById('imageUrl').value = dataUrl;
        
        // Load image to get dimensions
        const img = new Image();
        img.onload = function() {
            currentImageAspectRatio = this.naturalWidth / this.naturalHeight;
            
            // Calculate default size (50% of slide width, assuming ~700px slide width)
            const defaultWidth = 300;
            const defaultHeight = Math.round(defaultWidth / currentImageAspectRatio);
            
            document.getElementById('imageWidth').value = defaultWidth;
            document.getElementById('imageHeight').value = defaultHeight;
        };
        img.src = dataUrl;
        
        // Show preview for upload tab
        if (currentImageMode === 'upload') {
            document.getElementById('fileUploadThumb').src = dataUrl;
            document.getElementById('fileUploadPreview').classList.remove('hidden');
        }
    };
    
    reader.onerror = function() {
        alert('Failed to load image. Try another file');
    };
    
    reader.readAsDataURL(file);
}

function addImage() {
    let url = document.getElementById('imageUrl').value.trim();
    
    console.log('addImage called, URL:', url);
    console.log('Current mode:', currentImageMode);
    
    // Validate URL or check for file upload
    if (!url) {
        alert('–í–≤–µ–¥–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!');
        console.error('No URL provided');
        return;
    }
    
    // Validate URL format if it's not a data URL
    if (!url.startsWith('data:') && !url.match(/^https?:\/\//i)) {
        alert('Please enter a valid image URL (must start with http:// or https://)');
        console.error('Invalid URL format:', url);
        return;
    }
    
    const layer = document.querySelector('input[name="imageLayer"]:checked')?.value || 'background';
    const width = parseInt(document.getElementById('imageWidth').value) || 200;
    const height = parseInt(document.getElementById('imageHeight').value) || 150;
    
    console.log('Creating image with:', { url, layer, width, height });
    
    const imageData = {
        id: currentEditingImageId || 'img_' + Date.now(),
        url: url,
        position: {
            x: parseInt(document.getElementById('imageX').value) || 100,
            y: parseInt(document.getElementById('imageY').value) || 100
        },
        size: {
            width: width,
            height: height
        },
        layer: layer,
        aspectRatio: currentImageAspectRatio || (width / height),
        aspectLocked: document.getElementById('imageAspectLock').checked
    };
    
    if (!slides[currentSlideIndex].images) {
        slides[currentSlideIndex].images = [];
    }
    
    if (currentEditingImageId) {
        // Update existing image
        const index = slides[currentSlideIndex].images.findIndex(img => img.id === currentEditingImageId);
        if (index !== -1) {
            slides[currentSlideIndex].images[index] = imageData;
            console.log('Updated image at index:', index);
        }
    } else {
        // Add new image
        slides[currentSlideIndex].images.push(imageData);
        console.log('Added new image, total images:', slides[currentSlideIndex].images.length);
    }
    
    console.log('Updating lists and preview...');
    updateImagesList();
    updateSlidePreview();
    closeImageModal();
    console.log('Image added successfully');
}

function editImage(imageId) {
    const image = slides[currentSlideIndex].images.find(img => img.id === imageId);
    if (!image) return;
    
    currentEditingImageId = imageId;
    currentImageAspectRatio = image.aspectRatio || (image.size.width / image.size.height);
    
    // Fill modal with image data
    document.getElementById('imageUrl').value = image.url;
    document.getElementById('imageX').value = image.position.x;
    document.getElementById('imageY').value = image.position.y;
    document.getElementById('imageWidth').value = image.size.width;
    document.getElementById('imageHeight').value = image.size.height;
    document.getElementById('imageAspectLock').checked = image.aspectLocked !== false;
    
    const layerRadio = document.querySelector(`input[name="imageLayer"][value="${image.layer || 'background'}"]`);
    if (layerRadio) layerRadio.checked = true;
    
    // Show modal
    document.getElementById('imageModal').classList.remove('hidden');
}

function removeImage(imageId) {
    slides[currentSlideIndex].images = slides[currentSlideIndex].images.filter(img => img.id !== imageId);
    updateImagesList();
    updateSlidePreview();
}

function updateImagesList() {
    const container = document.getElementById('imagesList');
    const images = slides[currentSlideIndex].images || [];
    
    if (images.length === 0) {
        container.innerHTML = '<div class="text-xs text-gray-500 p-2">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</div>';
        return;
    }
    
    container.innerHTML = images.map(img => {
        const layerBadge = img.layer === 'foreground' 
            ? '<span class="px-1 py-0.5 bg-blue-500 text-white text-xs rounded ml-1">FG</span>'
            : '<span class="px-1 py-0.5 bg-gray-500 text-white text-xs rounded ml-1">BG</span>';
        
        const thumbnailUrl = img.url.startsWith('data:') ? img.url : img.url;
        
        return `
            <div class="flex items-center gap-2 p-2 bg-gray-50 rounded text-xs">
                <img src="${thumbnailUrl}" class="w-10 h-10 object-cover rounded border" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22%3E%3Crect fill=%22%23ddd%22 width=%2240%22 height=%2240%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-size=%2212%22%3EIMG%3C/text%3E%3C/svg%3E'">
                <span class="truncate flex-1" title="${img.url}">${img.url.substring(0, 20)}...</span>
                ${layerBadge}
                <button onclick="editImage('${img.id}')" class="text-blue-500 hover:text-blue-700" title="Edit">‚úèÔ∏è</button>
                <button onclick="removeImage('${img.id}')" class="text-red-500 hover:text-red-700" title="Delete">‚úï</button>
            </div>
        `;
    }).join('');
}

// Table management functions
function showTableModal() {
    document.getElementById('tableModal').classList.remove('hidden');
}

function closeTableModal() {
    document.getElementById('tableModal').classList.add('hidden');
}

function addTable() {
    const table = {
        id: 'tbl_' + Date.now(),
        rows: parseInt(document.getElementById('tableRows').value),
        columns: parseInt(document.getElementById('tableColumns').value),
        position: {
            x: parseInt(document.getElementById('tableX').value),
            y: parseInt(document.getElementById('tableY').value)
        },
        size: {
            width: parseInt(document.getElementById('tableWidth').value),
            height: parseInt(document.getElementById('tableHeight').value)
        },
        cellData: {}
    };
    
    if (!slides[currentSlideIndex].tables) {
        slides[currentSlideIndex].tables = [];
    }
    slides[currentSlideIndex].tables.push(table);
    
    updateTablesList();
    closeTableModal();
}

function removeTable(tableId) {
    slides[currentSlideIndex].tables = slides[currentSlideIndex].tables.filter(tbl => tbl.id !== tableId);
    updateTablesList();
}

function updateTablesList() {
    const container = document.getElementById('tablesList');
    const tables = slides[currentSlideIndex].tables || [];
    
    if (tables.length === 0) {
        container.innerHTML = '<div class="text-xs text-gray-500 p-2">–ù–µ—Ç —Ç–∞–±–ª–∏—Ü</div>';
        return;
    }
    
    container.innerHTML = tables.map(tbl => `
        <div class="flex items-center justify-between p-2 bg-gray-50 rounded text-xs">
            <span>–¢–∞–±–ª–∏—Ü–∞ ${tbl.rows}x${tbl.columns}</span>
            <button onclick="removeTable('${tbl.id}')" class="text-red-500 hover:text-red-700 ml-2">‚úï</button>
        </div>
    `).join('');
}

// Arrow management functions
function showArrowModal() {
    document.getElementById('arrowModal').classList.remove('hidden');
}

function closeArrowModal() {
    document.getElementById('arrowModal').classList.add('hidden');
}

function addArrow() {
    const arrow = {
        id: 'arr_' + Date.now(),
        type: document.getElementById('arrowType').value,
        startPoint: {
            x: parseInt(document.getElementById('arrowStartX').value),
            y: parseInt(document.getElementById('arrowStartY').value)
        },
        endPoint: {
            x: parseInt(document.getElementById('arrowEndX').value),
            y: parseInt(document.getElementById('arrowEndY').value)
        },
        color: document.getElementById('arrowColor').value,
        strokeWidth: parseInt(document.getElementById('arrowStroke').value)
    };
    
    if (!slides[currentSlideIndex].arrows) {
        slides[currentSlideIndex].arrows = [];
    }
    slides[currentSlideIndex].arrows.push(arrow);
    
    updateArrowsList();
    closeArrowModal();
}

function removeArrow(arrowId) {
    slides[currentSlideIndex].arrows = slides[currentSlideIndex].arrows.filter(arr => arr.id !== arrowId);
    updateArrowsList();
}

function updateArrowsList() {
    const container = document.getElementById('arrowsList');
    const arrows = slides[currentSlideIndex].arrows || [];
    
    if (arrows.length === 0) {
        container.innerHTML = '<div class="text-xs text-gray-500 p-2">–ù–µ—Ç —Å—Ç—Ä–µ–ª–æ–∫</div>';
        return;
    }
    
    container.innerHTML = arrows.map(arr => `
        <div class="flex items-center justify-between p-2 bg-gray-50 rounded text-xs">
            <span>–°—Ç—Ä–µ–ª–∫–∞ (${arr.type})</span>
            <button onclick="removeArrow('${arr.id}')" class="text-red-500 hover:text-red-700 ml-2">‚úï</button>
        </div>
    `).join('');
}

// Drag and drop setup for slide preview
function setupPreviewDragDrop() {
    const preview = document.getElementById('slidePreview');
    
    preview.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        preview.classList.add('border-blue-500', 'bg-blue-50');
    });
    
    preview.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        preview.classList.remove('border-blue-500', 'bg-blue-50');
    });
    
    preview.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        preview.classList.remove('border-blue-500', 'bg-blue-50');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            // Get drop position relative to preview
            const rect = preview.getBoundingClientRect();
            const x = Math.round(e.clientX - rect.left);
            const y = Math.round(e.clientY - rect.top);
            
            // Process first file
            const file = files[0];
            if (validateImageFile(file)) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const dataUrl = event.target.result;
                    
                    // Load image to get dimensions
                    const img = new Image();
                    img.onload = function() {
                        const aspectRatio = this.naturalWidth / this.naturalHeight;
                        const defaultWidth = 200;
                        const defaultHeight = Math.round(defaultWidth / aspectRatio);
                        
                        // Add image directly to slide
                        const imageData = {
                            id: 'img_' + Date.now(),
                            url: dataUrl,
                            position: { x: x, y: y },
                            size: { width: defaultWidth, height: defaultHeight },
                            layer: 'background',
                            aspectRatio: aspectRatio,
                            aspectLocked: true
                        };
                        
                        if (!slides[currentSlideIndex].images) {
                            slides[currentSlideIndex].images = [];
                        }
                        slides[currentSlideIndex].images.push(imageData);
                        
                        updateImagesList();
                        updateSlidePreview();
                    };
                    img.src = dataUrl;
                };
                reader.readAsDataURL(file);
            }
        }
    });
}

// File input handlers setup
function setupFileInputHandlers() {
    // Drop zone click handler
    const dropZone = document.getElementById('dropZone');
    const dropZoneInput = document.getElementById('dropZoneFileInput');
    
    if (dropZone && dropZoneInput) {
        dropZone.addEventListener('click', () => {
            dropZoneInput.click();
        });
        
        dropZoneInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                processImageFile(file);
                document.getElementById('dropZoneFileName').textContent = `Selected: ${file.name}`;
                document.getElementById('dropZoneFileName').classList.remove('hidden');
            }
        });
    }
    
    // Upload file input handler
    const fileUploadInput = document.getElementById('fileUploadInput');
    if (fileUploadInput) {
        fileUploadInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                processImageFile(e.target.files[0]);
            }
        });
    }
    
    // Drop zone drag and drop
    if (dropZone) {
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('border-blue-500', 'bg-blue-100');
        });
        
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-blue-500', 'bg-blue-100');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-blue-500', 'bg-blue-100');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                processImageFile(file);
                document.getElementById('dropZoneFileName').textContent = `Selected: ${file.name}`;
                document.getElementById('dropZoneFileName').classList.remove('hidden');
                
                // Update the file input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                dropZoneInput.files = dataTransfer.files;
            }
        });
    }
}
</script>
{% endblock %}
