{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–æ—Ä —Å–ª–∞–π–¥–æ–≤{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-6 flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-900">–†–µ–¥–∞–∫—Ç–æ—Ä —Å–ª–∞–π–¥–æ–≤</h1>
        <div class="flex gap-3">
            <button onclick="window.location.href='/'" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                ‚Üê –ù–∞–∑–∞–¥
            </button>
            <button id="createBtn" onclick="generatePresentation(false)" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700">
                ‚ú® –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é
            </button>
            <button id="updateBtn" onclick="generatePresentation(true)" class="hidden px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é
            </button>
        </div>
    </div>

    <!-- Progress bar -->
    <div id="progressBar" class="hidden mb-6">
        <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div id="progressBarFill" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <p id="progressText" class="text-sm text-gray-600 mt-2 text-center">–û–±—Ä–∞–±–æ—Ç–∫–∞...</p>
    </div>

    <div class="grid grid-cols-12 gap-6">
        <!-- Slides List (Left Panel) -->
        <div class="col-span-3">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">–°–ª–∞–π–¥—ã</h2>
                    <button onclick="addNewSlide()" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                        + –ù–æ–≤—ã–π
                    </button>
                </div>
                <div id="slidesList" class="space-y-2 max-h-[70vh] overflow-y-auto">
                    <!-- Slides will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Slide Editor (Center Panel) -->
        <div class="col-span-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="mb-4 flex justify-between items-center">
                    <h2 class="text-lg font-bold">–°–ª–∞–π–¥ <span id="currentSlideNumber">1</span></h2>
                    <button onclick="deleteCurrentSlide()" class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                        üóë –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>

                <!-- Slide Preview -->
                <div id="slidePreview" class="mb-6 border-2 border-gray-300 rounded-lg overflow-hidden bg-gradient-to-br from-blue-900 to-purple-900 relative" style="aspect-ratio: 16/9;">
                    <div class="absolute inset-0 p-8 flex flex-col">
                        <div id="previewTitle" class="text-white text-3xl font-bold mb-4"></div>
                        <div id="previewMain" class="text-white text-lg flex-1 overflow-y-auto whitespace-pre-wrap"></div>
                        <div id="previewSecondary" class="text-gray-300 text-sm mt-2"></div>
                    </div>
                </div>

                <!-- Text Editors -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ó–∞–≥–æ–ª–æ–≤–æ–∫ (‚â§6 —Å–ª–æ–≤)</label>
                        <input type="text" 
                               id="titleInput" 
                               class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="–ö—Ä–∞—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫"
                               oninput="updateSlidePreview()">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç
                            <span class="text-gray-500 font-normal">(–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–∏—Å–∫–∏ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å ":"):</span>
                        </label>
                        <textarea id="mainTextInput" 
                                  rows="8"
                                  class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                                  placeholder="–û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏:&#10;–†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–æ—Ç–æ—Ç–∏–ø&#10;–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ&#10;&#10;‚Ä¢ –ü–µ—Ä–≤—ã–π –ø—É–Ω–∫—Ç&#10;‚Ä¢ –í—Ç–æ—Ä–æ–π –ø—É–Ω–∫—Ç"
                                  oninput="updateSlidePreview()"></textarea>
                        <p class="text-xs text-gray-500 mt-1">
                            –ü–æ–¥—Å–∫–∞–∑–∫–∞: –°—Ç—Ä–æ–∫–∏ —Å ":" —Å—Ç–∞–Ω—É—Ç –∂–∏—Ä–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏, —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏ - —Å–ø–∏—Å–∫–æ–º
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç</label>
                        <textarea id="secondaryTextInput" 
                                  rows="2"
                                  class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  placeholder="–°–Ω–æ—Å–∫–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏"
                                  oninput="updateSlidePreview()"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Style Settings (Right Panel) -->
        <div class="col-span-3">
            <div class="bg-white rounded-lg shadow p-4">
                <h2 class="text-lg font-bold mb-4">–°—Ç–∏–ª—å</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–®–∞–±–ª–æ–Ω</label>
                        <select id="templateSelect" class="w-full p-2 border border-gray-300 rounded-lg" onchange="applyTemplateToAll()">
                            {% for template in templates %}
                            <option value="{{ template }}">{{ template }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–†–∞–∑–º–µ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–∞</label>
                        <input type="range" id="titleSize" min="24" max="60" value="44" class="w-full"
                               oninput="updatePreviewStyles(); document.getElementById('titleSizeValue').textContent = this.value">
                        <span id="titleSizeValue" class="text-sm text-gray-600">44</span> PT
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞</label>
                        <input type="range" id="textSize" min="12" max="32" value="18" class="w-full"
                               oninput="updatePreviewStyles(); document.getElementById('textSizeValue').textContent = this.value">
                        <span id="textSizeValue" class="text-sm text-gray-600">18</span> PT
                    </div>

                    <div class="pt-4 border-t">
                        <button onclick="applyToAll()" class="w-full px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">
                            –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º —Å–ª–∞–π–¥–∞–º
                        </button>
                    </div>
                </div>
            </div>

            <!-- Info Panel -->
            <div class="bg-blue-50 rounded-lg p-4 mt-4">
                <h3 class="font-bold text-blue-900 mb-2">üí° –°–æ–≤–µ—Ç—ã</h3>
                <ul class="text-xs text-blue-800 space-y-1">
                    <li>‚Ä¢ –ó–∞–≥–æ–ª–æ–≤–∫–∏: –¥–æ 6 —Å–ª–æ–≤</li>
                    <li>‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ":" –¥–ª—è –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤</li>
                    <li>‚Ä¢ "‚Ä¢" –∏–ª–∏ "-" –¥–ª—è —Å–ø–∏—Å–∫–æ–≤</li>
                    <li>‚Ä¢ –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ = –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
let slides = {{ slides_data | tojson }};
let currentSlideIndex = 0;
const presentationUrl = '{{ presentation_url }}';
const template = '{{ template }}';
let generatedPresentationId = null;  // NEW: Track generated presentation

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    renderSlidesList();
    loadSlide(0);
    
    // Check if we have a generated presentation from previous run
    const urlParams = new URLSearchParams(window.location.search);
    const jobId = urlParams.get('job_id');
    if (jobId) {
        checkForGeneratedPresentation(jobId);
    }
});

function checkForGeneratedPresentation(jobId) {
    // Check if this job already generated a presentation
    fetch(`/api/job/${jobId}`)
        .then(response => response.json())
        .then(job => {
            if (job.generated_presentation_id) {
                generatedPresentationId = job.generated_presentation_id;
                // Show update button, hide create button
                document.getElementById('createBtn').classList.add('hidden');
                document.getElementById('updateBtn').classList.remove('hidden');
            }
        })
        .catch(err => console.error('Error checking job:', err));
}

function renderSlidesList() {
    const container = document.getElementById('slidesList');
    if (slides.length === 0) {
        container.innerHTML = '<div class="p-4 text-gray-500 text-sm">–ù–µ—Ç —Å–ª–∞–π–¥–æ–≤</div>';
        return;
    }
    container.innerHTML = slides.map((slide, index) => {
        const title = slide.title || '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞';
        const preview = (slide.mainText || '').substring(0, 30);
        return `
        <div onclick="loadSlide(${index})" 
             class="p-3 rounded cursor-pointer transition ${index === currentSlideIndex ? 'bg-blue-100 border-2 border-blue-500' : 'bg-gray-50 hover:bg-gray-100 border border-gray-200'}">
            <div class="font-semibold text-sm">${index + 1}. ${title}</div>
            <div class="text-xs text-gray-500 mt-1 truncate">${preview}${preview ? '...' : ''}</div>
        </div>
    `;
    }).join('');
}

function loadSlide(index) {
    // Save current slide first
    if (currentSlideIndex >= 0 && currentSlideIndex < slides.length) {
        saveCurrentSlide();
    }

    currentSlideIndex = index;
    const slide = slides[index];

    document.getElementById('currentSlideNumber').textContent = index + 1;
    document.getElementById('titleInput').value = slide.title || '';
    document.getElementById('mainTextInput').value = slide.mainText || '';
    document.getElementById('secondaryTextInput').value = slide.secondaryText || '';

    updateSlidePreview();
    renderSlidesList();
}

function saveCurrentSlide() {
    slides[currentSlideIndex] = {
        ...slides[currentSlideIndex],
        title: document.getElementById('titleInput').value,
        mainText: document.getElementById('mainTextInput').value,
        secondaryText: document.getElementById('secondaryTextInput').value
    };
}

function updateSlidePreview() {
    const title = document.getElementById('titleInput').value;
    const mainText = document.getElementById('mainTextInput').value;
    const secondaryText = document.getElementById('secondaryTextInput').value;

    // Update preview
    document.getElementById('previewTitle').textContent = title;
    document.getElementById('previewMain').innerHTML = formatMainText(mainText);
    document.getElementById('previewSecondary').textContent = secondaryText;

    updatePreviewStyles();
}

function formatMainText(text) {
    if (!text) return '';
    
    const lines = text.split('\n');
    let html = '';
    
    for (let line of lines) {
        if (line.trim().endsWith(':')) {
            // Bold heading
            html += `<div class="font-bold mt-2">${line}</div>`;
        } else if (line.trim().startsWith('‚Ä¢') || line.trim().startsWith('-')) {
            // Bullet point
            html += `<div class="ml-4">${line}</div>`;
        } else if (line.trim().match(/^\d+\./)) {
            // Numbered list
            html += `<div class="ml-4">${line}</div>`;
        } else if (line.trim()) {
            html += `<div>${line}</div>`;
        } else {
            html += '<div class="h-2"></div>';
        }
    }
    
    return html;
}

function updatePreviewStyles() {
    const titleSize = document.getElementById('titleSize').value;
    const textSize = document.getElementById('textSize').value;
    
    document.getElementById('previewTitle').style.fontSize = `${titleSize}px`;
    document.getElementById('previewMain').style.fontSize = `${textSize}px`;
}

function addNewSlide() {
    const newSlide = {
        title: '',
        mainText: '',
        secondaryText: '',
        role: 'CONTENT'
    };
    
    slides.push(newSlide);
    renderSlidesList();
    loadSlide(slides.length - 1);
}

function deleteCurrentSlide() {
    if (slides.length <= 1) {
        alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–ª–∞–π–¥!');
        return;
    }
    
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Å–ª–∞–π–¥ ${currentSlideIndex + 1}?`)) {
        return;
    }
    
    slides.splice(currentSlideIndex, 1);
    currentSlideIndex = Math.max(0, currentSlideIndex - 1);
    renderSlidesList();
    loadSlide(currentSlideIndex);
}

function applyToAll() {
    const titleSize = document.getElementById('titleSize').value;
    const textSize = document.getElementById('textSize').value;
    
    slides = slides.map(slide => ({
        ...slide,
        titleSize: parseInt(titleSize),
        textSize: parseInt(textSize)
    }));
    
    alert('–°—Ç–∏–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫–æ –≤—Å–µ–º —Å–ª–∞–π–¥–∞–º!');
}

function applyTemplateToAll() {
    const template = document.getElementById('templateSelect').value;
    slides = slides.map(slide => ({
        ...slide,
        template: template
    }));
}

async function generatePresentation(isUpdate = false) {
    // Save current slide
    saveCurrentSlide();
    
    // Show progress
    document.getElementById('progressBar').classList.remove('hidden');
    document.getElementById('progressBarFill').style.width = '20%';
    
    if (isUpdate && generatedPresentationId) {
        document.getElementById('progressText').textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏...';
    } else {
        document.getElementById('progressText').textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–ª–∞–π–¥–æ–≤...';
    }
    
    try {
        const response = await fetch('/process_slides', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                slides: slides,
                template: document.getElementById('templateSelect').value,
                presentation_url: presentationUrl,
                existing_presentation_id: isUpdate ? generatedPresentationId : null  // NEW: Pass ID for updates
            })
        });
        
        document.getElementById('progressBarFill').style.width = '50%';
        document.getElementById('progressText').textContent = isUpdate ? '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏...' : '–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏...';
        
        const result = await response.json();
        
        document.getElementById('progressBarFill').style.width = '100%';
        document.getElementById('progressText').textContent = '–ì–æ—Ç–æ–≤–æ!';
        
        if (result.job_id) {
            window.location.href = `/job/${result.job_id}`;
        } else if (result.error) {
            alert('–û—à–∏–±–∫–∞: ' + result.error);
            document.getElementById('progressBar').classList.add('hidden');
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ ' + (isUpdate ? '–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏' : '—Å–æ–∑–¥–∞–Ω–∏–∏') + ' –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏: ' + error);
        document.getElementById('progressBar').classList.add('hidden');
    }
}
</script>
{% endblock %}
